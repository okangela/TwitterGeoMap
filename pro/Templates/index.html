<!doctype html>
<html>
  <head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.1.0.min.js"></script>
    <script src="http://maps.google.com/maps/api/js?sensor=false" type="text/javascript"></script>

    <script type="text/javascript">
    var gmarkers=[];
    $(document).ready(function(){
      var map = new google.maps.Map(document.getElementById('map'), {
        zoom: 2,
        center: new google.maps.LatLng(-33.868,151.219),
        mapTypeId: google.maps.MapTypeId.ROADMAP
      });

      var infowindow = new google.maps.InfoWindow();

      var marker, i;

      $("#text_value").click(function(){

        // function toggleMarkers(){
        //   for (i=0; i<gmarkers.length; i++){
        //     if (gmarkers[i].getMap() !=null) gmarkers[i].setMap(null);
        //     else gmarkers[i].setMap(map);
        //   }
        // }

        $.each(gmarkers, function() {
            this.setMap(null);
          });

        var text_value = $("#text").val();

        $.ajax({
          url:"/search",
          type:"GET",
          data:{
            q:text_value
          },
          dataType:"json",
          success:function(data){
            var length = data.length
            for (i = 1; i < length; i++) {
              marker = new google.maps.Marker({
                position: new google.maps.LatLng(data[i][0], data[i][1]),
                map: map
              });
              gmarkers.push(marker);


              google.maps.event.addListener(marker, 'mouseover', (function(marker, i) {
                return function() {
                  infowindow.setContent(String(data[i][2])+','+String(data[i][3]))
                  infowindow.open(map, marker);
                }
              })(marker, i));
            }
          console.log(data)
          }
        });

      });

      $.ajax({
        url:"/search",
        type:"GET",
        data:{
          q:'*'
        },
        dataType:"json",
        success:function(data){
          var length = data.length
          for (i = 1; i < length; i++) {
            marker = new google.maps.Marker({
              position: new google.maps.LatLng(data[i][0], data[i][1]),
              map: map
            });
            gmarkers.push(marker);

            google.maps.event.addListener(marker, 'mouseover', (function(marker, i) {
              return function() {
                var contentString =
                '<h4>Tweet by :</h4>'+String(data[i][3])+
                '<p>'+String(data[i][2])+'</p>';
                infowindow.setContent(contentString)
                infowindow.open(map, marker);
              }
            })(marker, i));

            google.maps.event.addListener(marker, 'mouseout', (function(marker, i) {
              return function() {
                infowindow.close();
              }
            })(marker, i));
          }
        console.log(data)
        }
      });

      });
    </script>
  </head>
  <body>
    <center>
      <h4> HERE'S YOUR FUCKING GEO MAP </h4>
      <main>
          <label>Input :</label>
          <input type="text" id="text" name="name" value="" />
          <input type="button" id="text_value" value="Get Value"/><br>
          <div id="map" style="width: 1200px; height: 630px;"></div>
      </main>
    </center>
  </body>
</html>
